<!DOCTYPE html>
<html lang="fr">
  <head>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Room secr√®te ‚Äî Joyeux Bordel</title>
    <style>
      :root {
        --bg: #07070a;
        --card: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.12);
        --text: #fff;
        --muted: rgba(255, 255, 255, 0.72);
        --accent: #ffcc00;
        --good: #34d399;
        --bad: #fb7185;
        --blue: #60a5fa;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color: var(--text);
        background: radial-gradient(
            900px 650px at 20% 10%,
            rgba(255, 204, 0, 0.12),
            transparent 60%
          ),
          radial-gradient(
            900px 650px at 80% 25%,
            rgba(96, 165, 250, 0.1),
            transparent 60%
          ),
          radial-gradient(
            1200px 900px at 50% 95%,
            rgba(251, 113, 133, 0.08),
            transparent 60%
          ),
          var(--bg);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 24px;
      }
      .wrap {
        width: min(980px, 100%);
      }

      header {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
      }
      h1 {
        margin: 0;
        font-size: 2.1rem;
        letter-spacing: 0.2px;
      }
      .sub {
        margin: 8px 0 0 0;
        opacity: 0.75;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.25);
        color: var(--text);
        text-decoration: none;
        opacity: 0.9;
        user-select: none;
        cursor: pointer;
      }
      .btn:hover {
        opacity: 1;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 16px;
        box-shadow: 0 20px 70px rgba(0, 0, 0, 0.45);
        overflow: hidden;
        position: relative;
      }

      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .grow {
        flex: 1 1 auto;
      }

      input,
      textarea {
        width: 100%;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.22);
        color: var(--text);
        outline: none;
        font-size: 1rem;
      }
      input::placeholder,
      textarea::placeholder {
        color: rgba(255, 255, 255, 0.45);
      }

      .cta {
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 204, 0, 0.22);
        background: rgba(255, 204, 0, 0.14);
        color: var(--text);
        cursor: pointer;
        font-weight: 900;
        user-select: none;
      }
      .cta:hover {
        background: rgba(255, 204, 0, 0.18);
      }

      .ghost {
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.18);
        color: var(--text);
        cursor: pointer;
        opacity: 0.9;
        user-select: none;
      }
      .ghost:hover {
        opacity: 1;
      }

      .hint {
        margin: 10px 0 0 0;
        opacity: 0.62;
        font-size: 0.95rem;
        line-height: 1.4;
      }
      .hint code {
        background: rgba(0, 0, 0, 0.35);
        padding: 2px 6px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Login screen */
      .loginGrid {
        display: grid;
        grid-template-columns: 1fr 0.9fr;
        gap: 14px;
        align-items: start;
      }
      @media (max-width: 900px) {
        .loginGrid {
          grid-template-columns: 1fr;
        }
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.18);
        opacity: 0.92;
        font-size: 0.95rem;
        user-select: none;
        white-space: nowrap;
      }
      .badge b {
        color: var(--accent);
      }

      /* Chat */
      .chatLayout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .chatTop {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
      }
      .chatBox {
        height: min(62vh, 560px);
        overflow: auto;
        padding: 14px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.2);
      }
      .msg {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: flex-start;
      }
      .avatar {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.06);
        flex: 0 0 auto;
        user-select: none;
      }
      .bubble {
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        max-width: 720px;
        width: fit-content;
      }
      .metaLine {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: baseline;
        margin-bottom: 2px;
      }
      .who {
        font-weight: 900;
        color: var(--accent);
      }
      .time {
        opacity: 0.55;
        font-size: 0.92rem;
      }
      .text {
        white-space: pre-wrap;
        line-height: 1.35;
      }

      .sys .bubble {
        border-color: rgba(96, 165, 250, 0.22);
        background: rgba(96, 165, 250, 0.08);
      }
      .sys .who {
        color: var(--blue);
      }

      .me .bubble {
        border-color: rgba(52, 211, 153, 0.22);
        background: rgba(52, 211, 153, 0.08);
      }
      .me .who {
        color: var(--good);
      }

      .chatInputRow {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .chatInputRow textarea {
        height: 50px;
        resize: none;
        padding-top: 14px;
      }

      /* Toast */
      .toast {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        background: rgba(15, 15, 20, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 14px;
        padding: 10px 14px;
        font-size: 1rem;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.18s ease, transform 0.18s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
        max-width: min(900px, 92vw);
        text-align: center;
        z-index: 999;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-4px);
      }
      .toast code {
        background: rgba(0, 0, 0, 0.35);
        padding: 2px 6px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Confetti micro */
      .confetti {
        position: fixed;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .confetti.on {
        opacity: 1;
      }
      .confetti i {
        position: absolute;
        width: 8px;
        height: 12px;
        background: rgba(255, 204, 0, 0.9);
        border-radius: 3px;
        animation: fall 900ms linear forwards;
        filter: drop-shadow(0 0 8px rgba(255, 204, 0, 0.12));
      }
      @keyframes fall {
        0% {
          transform: translateY(-20px) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(110vh) rotate(260deg);
          opacity: 0;
        }
      }

      /* ‚ÄúAgent mode‚Äù egg */
      body.agent {
        background: radial-gradient(
            1200px 900px at 50% 0%,
            rgba(52, 211, 153, 0.12),
            transparent 60%
          ),
          radial-gradient(
            1200px 900px at 80% 25%,
            rgba(96, 165, 250, 0.1),
            transparent 60%
          ),
          radial-gradient(
            1200px 900px at 20% 40%,
            rgba(255, 204, 0, 0.08),
            transparent 60%
          ),
          #05070b;
      }
      body.agent .card {
        border-color: rgba(52, 211, 153, 0.18);
        box-shadow: 0 30px 120px rgba(52, 211, 153, 0.07),
          0 20px 70px rgba(0, 0, 0, 0.45);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <h1>Room secr√®te</h1>
          <p class="sub">Acc√®s r√©serv√©. Ici, on complote gentiment.</p>
        </div>
        <div class="row">
          <a class="btn" href="/">‚Üê retour</a>
          <button class="btn" id="lockBtn" style="display: none">
            üîí Verrouiller
          </button>
        </div>
      </header>

      <!-- LOGIN -->
      <div class="card" id="loginCard">
        <div class="loginGrid">
          <div>
            <div class="row" style="justify-content: space-between">
              <div class="badge">üîê Niveau : <b>Top Secret</b></div>
              <div class="badge">‚å®Ô∏è Astuce : <b>ESC</b> pour lock</div>
            </div>

            <p style="margin: 14px 0 10px 0; opacity: 0.85">
              Entrez le mot de passe pour acc√©der au repaire.
            </p>

            <div class="row">
              <div class="grow">
                <input
                  id="password"
                  type="password"
                  placeholder="mot de passe‚Ä¶"
                  autocomplete="current-password"
                />
              </div>
              <button class="cta" id="enterBtn">Entrer</button>
            </div>

            <p class="hint">
              Mot de passe actuel (par d√©faut) : <code>chat</code> ‚Äî tu peux le
              changer dans le code (voir en bas).
            </p>

            <p class="hint">
              ü•ö Egg ici : tape <code>agent</code> dans le champ et appuie
              Entr√©e.
            </p>
          </div>

          <div>
            <div
              class="card"
              style="padding: 14px; background: rgba(0, 0, 0, 0.18)"
            >
              <p
                style="
                  margin: 0 0 8px 0;
                  font-weight: 900;
                  color: var(--accent);
                "
              >
                R√®gles de la room
              </p>
              <p style="margin: 0; opacity: 0.78; line-height: 1.45">
                - Ici on se dit des trucs cools.<br />
                - Pas de gros mots (sauf ‚Äúfus√©e‚Äù).<br />
                - Les messages restent sur <b>cet appareil</b> (local).<br />
                - On peut vider le chat si besoin.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="card" id="chatCard" style="display: none">
        <div class="chatLayout">
          <div class="chatTop">
            <div class="row">
              <div class="badge">‚úÖ Acc√®s : <b>OK</b></div>
              <div class="badge">üë§ Pseudo : <b id="whoNow">?</b></div>
              <div class="badge">üß† Mode : <b id="modeNow">normal</b></div>
            </div>

            <div class="row">
              <button class="ghost" id="changeNameBtn">Changer pseudo</button>
              <button class="ghost" id="clearBtn">Vider chat</button>
            </div>
          </div>

          <div class="chatBox" id="chatBox"></div>

          <div class="chatInputRow">
            <textarea
              id="msg"
              placeholder="√âcris un message‚Ä¶ (Entr√©e = envoyer, Shift+Entr√©e = nouvelle ligne)"
            ></textarea>
            <button class="cta" id="sendBtn">Envoyer</button>
          </div>

          <p class="hint" style="margin: 6px 0 0 0">
            ü•ö Dans la room : tape <code>/help</code> ou <code>/boom</code> üòâ
          </p>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="confetti" id="confetti"></div>

    <script>
      /**********************
       * SUPABASE (config)
       **********************/
      const SUPABASE_URL = "https://ovkqcsoixkosulkrhcuu.supabase.co";
      const SUPABASE_ANON_KEY =
        "sb_publishable_Gkm2Xp-2m1y9_jDgShNPag_DShD81JS";

      // client Supabase (version light sans bundler)
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      /**********************
       * CONFIG (toi)
       **********************/
      const ROOM_PASSWORD = "chat"; // mot de passe du QG
      const ROOM_CODE = "QG-ULYSSE"; // identifiant de room (important)
      const STORAGE_KEY = "joyeuxbordel_secret_chat_v1";
      const NAME_KEY = "joyeuxbordel_secret_name_v1";
      const SESSION_KEY = "joyeuxbordel_secret_session_v1";
      const SESSION_HOURS = 6; // dur√©e de session apr√®s login

      /**********************
       * Utils
       **********************/
      const $ = (id) => document.getElementById(id);

      function frTime(ts) {
        const d = new Date(ts);
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        const ss = String(d.getSeconds()).padStart(2, "0");
        return `${hh}:${mm}:${ss}`;
      }

      function toast(msg) {
        const t = $("toast");
        t.innerHTML = msg;
        t.classList.add("show");
        clearTimeout(toast._timer);
        toast._timer = setTimeout(() => t.classList.remove("show"), 1700);
      }

      function confettiPop() {
        const c = $("confetti");
        c.classList.add("on");
        for (let i = 0; i < 26; i++) {
          const el = document.createElement("i");
          el.style.left = Math.random() * 100 + "vw";
          el.style.top = -10 - Math.random() * 30 + "px";
          el.style.transform = `rotate(${Math.random() * 180}deg)`;
          el.style.opacity = (0.6 + Math.random() * 0.4).toFixed(2);
          el.style.background =
            Math.random() > 0.5
              ? "rgba(255,204,0,.95)"
              : "rgba(96,165,250,.75)";
          c.appendChild(el);
          setTimeout(() => el.remove(), 1000);
        }
        setTimeout(() => c.classList.remove("on"), 900);
      }

      function loadMessages() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        } catch {
          return [];
        }
      }
      function saveMessages(msgs) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(msgs));
      }
      function systemMessage(text) {
        const msgs = loadMessages();
        msgs.push({ who: "SYSTEM", text, ts: Date.now(), type: "sys" });
        saveMessages(msgs);
        renderChat();
      }

      function getName() {
        return localStorage.getItem(NAME_KEY) || "";
      }
      function setName(n) {
        localStorage.setItem(NAME_KEY, n);
        $("whoNow").textContent = n || "anonyme";
      }

      function setSession() {
        const exp = Date.now() + SESSION_HOURS * 60 * 60 * 1000;
        sessionStorage.setItem(SESSION_KEY, String(exp));
      }
      function hasSession() {
        const exp = parseInt(sessionStorage.getItem(SESSION_KEY) || "0", 10);
        return exp && Date.now() < exp;
      }
      function clearSession() {
        sessionStorage.removeItem(SESSION_KEY);
      }

      /**********************
       * UI switching
       **********************/
      function showChat() {
        $("loginCard").style.display = "none";
        $("chatCard").style.display = "block";
        $("lockBtn").style.display = "inline-flex";
        $("modeNow").textContent = document.body.classList.contains("agent")
          ? "agent"
          : "normal";
        confettiPop();
        toast("‚úÖ Bienvenue dans la room secr√®te");
        if (!getName()) {
          askName();
        } else {
          $("whoNow").textContent = getName();
        }
        renderChat(true);
        systemMessage("Quelqu‚Äôun est entr√© dans la room üëÄ");
      }

      function showLogin() {
        $("loginCard").style.display = "block";
        $("chatCard").style.display = "none";
        $("lockBtn").style.display = "none";
      }

      function lock() {
        clearSession();
        showLogin();
        toast("üîí Verrouill√©");
        $("password").value = "";
        $("password").focus();
      }

      /**********************
       * Chat rendering
       **********************/
      function escapeHtml(str) {
        return str.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }

      function avatarFor(name) {
        const s = (name || "üôÇ").trim();
        const ch = s[0] ? s[0].toUpperCase() : "üôÇ";
        // If starts with emoji, keep it
        if (/\p{Extended_Pictographic}/u.test(ch)) return ch;
        return ch;
      }

      function renderChat(scrollBottom = false) {
        const box = $("chatBox");
        const msgs = loadMessages();
        const me = getName() || "anonyme";

        box.innerHTML = msgs
          .map((m) => {
            const who = escapeHtml(m.who);
            const text = escapeHtml(m.text);
            const time = frTime(m.ts);
            const isSys = m.type === "sys";
            const isMe = !isSys && m.who === me;

            const cls = isSys ? "msg sys" : isMe ? "msg me" : "msg";
            const av = isSys ? "üõ∞Ô∏è" : avatarFor(m.who);

            return `
          <div class="${cls}">
            <div class="avatar">${av}</div>
            <div class="bubble">
              <div class="metaLine">
                <div class="who">${isSys ? "SYSTEM" : who}</div>
                <div class="time">${time}</div>
              </div>
              <div class="text">${text}</div>
            </div>
          </div>
        `;
          })
          .join("");

        if (scrollBottom) {
          box.scrollTop = box.scrollHeight;
        }
      }

      function sendMessage(raw) {
        const text = (raw || "").trim();
        if (!text) return;

        // commands
        if (text.startsWith("/")) {
          handleCommand(text);
          $("msg").value = "";
          return;
        }

        const me = getName() || "anonyme";
        const msgs = loadMessages();
        msgs.push({ who: me, text, ts: Date.now(), type: "msg" });
        saveMessages(msgs);
        $("msg").value = "";
        renderChat(true);
      }

      function handleCommand(cmd) {
        const c = cmd.toLowerCase().trim();

        if (c === "/help") {
          toast("üìú Commandes: /help /boom /lock /name");
          systemMessage("Commandes: /help, /boom, /lock, /name");
          return;
        }
        if (c === "/boom") {
          confettiPop();
          toast("üí• BOOM !");
          systemMessage("üí• BOOM (confetti) !");
          return;
        }
        if (c === "/lock") {
          lock();
          return;
        }
        if (c === "/name") {
          askName();
          return;
        }

        toast("‚ùì Commande inconnue. Essaie /help");
      }

      function askName() {
        const current = getName();
        const n = prompt(
          "Choisis ton pseudo (ex: Ulysse, Papa, Maman, Ninja ü•∑)",
          current || ""
        );
        if (n !== null) {
          const clean = n.trim().slice(0, 22);
          if (clean) {
            setName(clean);
            toast(`üë§ Pseudo = ${clean}`);
            systemMessage(`${clean} a chang√© de pseudo ‚ú®`);
          }
        }
      }

      /**********************
       * Login
       **********************/
      function tryEnter() {
        const val = $("password").value.trim();

        // Egg: "agent" in password field toggles agent mode (fun)
        if (val.toLowerCase() === "agent") {
          document.body.classList.toggle("agent");
          $("modeNow").textContent = document.body.classList.contains("agent")
            ? "agent"
            : "normal";
          toast(
            `üï∂Ô∏è Mode agent ${
              document.body.classList.contains("agent") ? "ON" : "OFF"
            }`
          );
          $("password").value = "";
          return;
        }

        if (val === ROOM_PASSWORD) {
          setSession();
          showChat();
        } else {
          toast("üö´ Mot de passe incorrect");
        }
      }

      /**********************
       * Wire up
       **********************/
      $("enterBtn").addEventListener("click", tryEnter);
      $("password").addEventListener("keydown", (e) => {
        if (e.key === "Enter") tryEnter();
      });

      $("sendBtn").addEventListener("click", () => sendMessage($("msg").value));
      $("msg").addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage($("msg").value);
        }
      });

      $("changeNameBtn").addEventListener("click", askName);
      $("clearBtn").addEventListener("click", () => {
        if (confirm("Vider tout le chat sur cet appareil ?")) {
          saveMessages([]);
          renderChat();
          toast("üßπ Chat vid√©");
        }
      });

      $("lockBtn").addEventListener("click", lock);

      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          lock();
        }
      });

      // boot
      if (hasSession()) {
        showChat();
      } else {
        showLogin();
        $("password").focus();
      }

      // show current name in UI if exists
      if (getName()) {
        $("whoNow").textContent = getName();
      }
    </script>
  </body>
</html>
