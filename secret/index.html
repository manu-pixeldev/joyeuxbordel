<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Room secr√®te ‚Äî Joyeux Bordel</title>

    <!-- Supabase CDN (UNE SEULE FOIS) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
      :root {
        --bg: #07070a;
        --card: rgba(255, 255, 255, 0.08);
        --border: rgba(255, 255, 255, 0.14);
        --text: #ffffff;
        --muted: rgba(255, 255, 255, 0.7);
        --accent: #ffcc00;
        --good: #34d399;
        --bad: #fb7185;
        --blue: #60a5fa;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color: var(--text);
        background: radial-gradient(
            900px 650px at 20% 10%,
            rgba(255, 204, 0, 0.12),
            transparent 60%
          ),
          radial-gradient(
            800px 600px at 80% 20%,
            rgba(96, 165, 250, 0.12),
            transparent 60%
          ),
          linear-gradient(180deg, #050507, #0b0b10);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 28px 18px 50px;
        position: relative;
        z-index: 2;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 18px;
      }

      h1 {
        margin: 0;
        font-size: 44px;
        letter-spacing: -0.02em;
      }
      .sub {
        margin: 8px 0 0 0;
        opacity: 0.82;
      }

      .row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .grow {
        flex: 1;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 14px 45px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(14px);
      }

      .btn,
      .ghost,
      .cta {
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.22);
        color: white;
        padding: 10px 14px;
        border-radius: 999px;
        text-decoration: none;
        font-weight: 650;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }
      .cta {
        background: linear-gradient(135deg, #ffcc00, #f59e0b);
        color: #111;
        border: none;
      }
      .ghost {
        background: rgba(255, 255, 255, 0.06);
      }
      .btn:hover,
      .ghost:hover {
        filter: brightness(1.05);
      }

      input,
      textarea {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(0, 0, 0, 0.35);
        color: white;
        padding: 12px 12px;
        outline: none;
      }
      textarea {
        resize: vertical;
        min-height: 54px;
        max-height: 160px;
      }

      code {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.14);
        padding: 2px 8px;
        border-radius: 999px;
      }

      .badge {
        background: rgba(0, 0, 0, 0.22);
        border: 1px solid rgba(255, 255, 255, 0.14);
        padding: 8px 12px;
        border-radius: 999px;
        font-weight: 650;
      }
      .badge b {
        color: var(--accent);
      }

      .hint {
        margin: 10px 0 0 0;
        opacity: 0.78;
        line-height: 1.45;
      }

      .loginGrid {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 14px;
      }
      @media (max-width: 900px) {
        .loginGrid {
          grid-template-columns: 1fr;
        }
        h1 {
          font-size: 36px;
        }
      }

      .chatLayout {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .chatTop {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .chatBox {
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.25);
        border-radius: 16px;
        padding: 12px;
        height: 360px;
        overflow: auto;
      }

      .msg {
        display: grid;
        grid-template-columns: 44px 1fr;
        gap: 10px;
        margin: 10px 0;
        align-items: start;
      }
      .msg .avatar {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.14);
        font-size: 18px;
      }
      .msg .bubble {
        border-radius: 16px;
        padding: 10px 12px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
      }
      .msg.me .bubble {
        background: rgba(255, 204, 0, 0.12);
        border-color: rgba(255, 204, 0, 0.25);
      }
      .msg.sys .bubble {
        background: rgba(96, 165, 250, 0.1);
        border-color: rgba(96, 165, 250, 0.25);
      }
      .metaLine {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        font-size: 12px;
        opacity: 0.85;
        margin-bottom: 6px;
      }
      .who {
        font-weight: 800;
      }
      .text {
        white-space: pre-wrap;
        line-height: 1.35;
      }

      .chatInputRow {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: end;
      }

      .toast {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.18);
        padding: 10px 14px;
        border-radius: 999px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        z-index: 10;
        max-width: min(920px, 92vw);
        text-align: center;
      }
      .toast.show {
        opacity: 1;
      }

      .confetti {
        position: fixed;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        display: none;
        z-index: 9;
      }
      .confetti.on {
        display: block;
      }
      .confetti i {
        position: absolute;
        width: 10px;
        height: 16px;
        border-radius: 3px;
        animation: fall 1s ease-in forwards;
      }
      @keyframes fall {
        to {
          transform: translateY(110vh) rotate(360deg);
          opacity: 0;
        }
      }

      /* Mode agent (egg) */
      body.agent h1 {
        text-shadow: 0 0 18px rgba(96, 165, 250, 0.25);
      }

      /* ========= BOSS FINAL: INVASION ========= */
      #stars {
        position: fixed;
        inset: 0;
        z-index: 1;
        pointer-events: none;
        display: none;
      }
      body.invasion #stars {
        display: block;
      }

      body.invasion {
        background: radial-gradient(
            900px 650px at 30% 10%,
            rgba(124, 58, 237, 0.16),
            transparent 60%
          ),
          radial-gradient(
            900px 650px at 70% 25%,
            rgba(34, 211, 238, 0.12),
            transparent 60%
          ),
          radial-gradient(
            1200px 900px at 50% 90%,
            rgba(16, 185, 129, 0.1),
            transparent 60%
          ),
          linear-gradient(180deg, #020617, #000);
      }
      body.invasion :root {
      }

      body.invasion .card {
        border-color: rgba(34, 211, 238, 0.22);
        box-shadow: 0 18px 70px rgba(34, 211, 238, 0.08),
          0 14px 45px rgba(0, 0, 0, 0.45);
      }
      body.invasion .badge b {
        color: #22d3ee;
      }
      body.invasion .cta {
        background: linear-gradient(135deg, #22d3ee, #7c3aed);
        color: #071018;
      }
      body.invasion .msg.me .bubble {
        background: rgba(34, 211, 238, 0.12);
        border-color: rgba(34, 211, 238, 0.28);
      }

      /* ‚ÄúPage qui crame‚Äù overlay */
      .burnOverlay {
        position: fixed;
        inset: 0;
        z-index: 999;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.15s ease;
      }
      .burnOverlay.on {
        opacity: 1;
      }
      .burnOverlay::before {
        content: "";
        position: absolute;
        inset: -40px;
        background: radial-gradient(
            circle at 50% 60%,
            rgba(255, 180, 0, 0.85),
            rgba(255, 80, 0, 0.4) 30%,
            rgba(0, 0, 0, 0) 60%
          ),
          radial-gradient(
            circle at 30% 30%,
            rgba(255, 255, 255, 0.95),
            rgba(255, 255, 255, 0) 45%
          ),
          linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.75));
        filter: blur(0px);
        animation: burnPulse 1.4s ease-in-out infinite;
        mix-blend-mode: screen;
      }
      .burnOverlay::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
            circle at 20% 80%,
            rgba(0, 0, 0, 0),
            rgba(0, 0, 0, 0.85) 60%
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(0, 0, 0, 0),
            rgba(0, 0, 0, 0.75) 60%
          );
        animation: burnVignette 2.2s ease-in-out infinite;
      }
      @keyframes burnPulse {
        0% {
          transform: scale(1);
          opacity: 0.75;
        }
        50% {
          transform: scale(1.03);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 0.75;
        }
      }
      @keyframes burnVignette {
        0% {
          opacity: 0.35;
        }
        50% {
          opacity: 0.65;
        }
        100% {
          opacity: 0.35;
        }
      }

      /* Glitch tremble */
      body.shake .wrap {
        animation: shake 0.35s ease-in-out 0s 2;
      }
      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        20% {
          transform: translateX(-3px);
        }
        40% {
          transform: translateX(3px);
        }
        60% {
          transform: translateX(-2px);
        }
        80% {
          transform: translateX(2px);
        }
        100% {
          transform: translateX(0);
        }
      }
    </style>
  </head>

  <body>
    <canvas id="stars"></canvas>
    <div class="burnOverlay" id="burn"></div>

    <div class="wrap">
      <header>
        <div>
          <h1>Room secr√®te</h1>
          <p class="sub">Acc√®s r√©serv√©. Ici, on complote gentiment.</p>
        </div>
        <div class="row">
          <a class="btn" href="/">‚Üê retour</a>
          <button class="btn" id="lockBtn" style="display: none">
            üîí Verrouiller
          </button>
        </div>
      </header>

      <!-- LOGIN -->
      <div class="card" id="loginCard">
        <div class="loginGrid">
          <div>
            <div class="row" style="justify-content: space-between">
              <div class="badge">üîê Niveau : <b>Top Secret</b></div>
              <div class="badge">‚å®Ô∏è Astuce : <b>ESC</b> pour lock</div>
            </div>

            <p style="margin: 14px 0 10px 0; opacity: 0.85">
              Entrez le mot de passe pour acc√©der au repaire.
            </p>

            <div class="row">
              <div class="grow">
                <input
                  id="password"
                  type="password"
                  placeholder="mot de passe‚Ä¶"
                  autocomplete="current-password"
                />
              </div>
              <button class="cta" id="enterBtn">Entrer</button>
            </div>

            <p class="hint">Mot de passe actuel : <code>chat</code></p>

            <p class="hint">
              ü•ö Egg ici : tape <code>agent</code> dans le champ et appuie
              Entr√©e.
            </p>

            <p class="hint">
              üëë Boss final : d‚Äôabord <code>/radar</code> puis
              <code>/launch omega</code>
            </p>
          </div>

          <div>
            <div
              class="card"
              style="padding: 14px; background: rgba(0, 0, 0, 0.18)"
            >
              <p
                style="
                  margin: 0 0 8px 0;
                  font-weight: 900;
                  color: var(--accent);
                "
              >
                R√®gles de la room
              </p>
              <p style="margin: 0; opacity: 0.78; line-height: 1.45">
                - Ici on se dit des trucs cools.<br />
                - Pas de gros mots (sauf ‚Äúfus√©e‚Äù).<br />
                - PC ‚Üî t√©l√©phone : messages partag√©s.<br />
                - On peut vider le chat si besoin.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="card" id="chatCard" style="display: none">
        <div class="chatLayout">
          <div class="chatTop">
            <div class="row">
              <div class="badge">‚úÖ Acc√®s : <b>OK</b></div>
              <div class="badge">üë§ Pseudo : <b id="whoNow">?</b></div>
              <div class="badge">üß† Mode : <b id="modeNow">normal</b></div>
            </div>

            <div class="row">
              <button class="ghost" id="changeNameBtn">Changer pseudo</button>
              <button class="ghost" id="clearBtn">Vider chat</button>
            </div>
          </div>

          <div class="chatBox" id="chatBox"></div>

          <div class="chatInputRow">
            <textarea
              id="msg"
              placeholder="√âcris un message‚Ä¶ (Entr√©e = envoyer, Shift+Entr√©e = nouvelle ligne)"
            ></textarea>
            <button class="cta" id="sendBtn">Envoyer</button>
          </div>

          <p class="hint" style="margin: 6px 0 0 0">
            ü•ö Commandes: <code>/help</code> <code>/boom</code>
            <code>/radar</code> <code>/launch omega</code>
            <code>/reset-eggs</code>
          </p>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="confetti" id="confetti"></div>

    <script>
      /**********************
       * SUPABASE (config)
       **********************/
      const SUPABASE_URL = "https://ovkqcsoixkosulkrhcuu.supabase.co";
      const SUPABASE_ANON_KEY =
        "sb_publishable_Gkm2Xp-2m1y9_jDgShNPag_DShD81JS";
      // IMPORTANT: on n'utilise PAS le nom "supabase" pour √©viter les collisions
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      /**********************
       * CONFIG (toi)
       **********************/
      const ROOM_PASSWORD = "chat";
      const ROOM_CODE = "QG-ULYSSE";
      const NAME_KEY = "joyeuxbordel_secret_name_v1";
      const SESSION_KEY = "joyeuxbordel_secret_session_v1";
      const SESSION_HOURS = 6;

      // eggs (local device flags)
      const EGG_RADAR = "jb_egg_radar_v1";
      const EGG_BOSS = "jb_egg_boss_v1";

      /**********************
       * Utils
       **********************/
      const $ = (id) => document.getElementById(id);

      function frTime(ts) {
        const d = new Date(ts);
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        const ss = String(d.getSeconds()).padStart(2, "0");
        return `${hh}:${mm}:${ss}`;
      }

      function toast(msg) {
        const t = $("toast");
        t.innerHTML = msg;
        t.classList.add("show");
        clearTimeout(toast._timer);
        toast._timer = setTimeout(() => t.classList.remove("show"), 1700);
      }

      function confettiPop(stars = false) {
        const c = $("confetti");
        c.classList.add("on");
        for (let i = 0; i < 26; i++) {
          const el = document.createElement("i");
          el.style.left = Math.random() * 100 + "vw";
          el.style.top = -10 - Math.random() * 30 + "px";
          el.style.transform = `rotate(${Math.random() * 180}deg)`;
          el.style.opacity = (0.6 + Math.random() * 0.4).toFixed(2);
          if (stars) {
            el.style.width = "8px";
            el.style.height = "8px";
            el.style.borderRadius = "50%";
            el.style.background =
              Math.random() > 0.5
                ? "rgba(34,211,238,.95)"
                : "rgba(124,58,237,.85)";
          } else {
            el.style.background =
              Math.random() > 0.5
                ? "rgba(255,204,0,.95)"
                : "rgba(96,165,250,.75)";
          }
          c.appendChild(el);
          setTimeout(() => el.remove(), 1000);
        }
        setTimeout(() => c.classList.remove("on"), 900);
      }

      function escapeHtml(str) {
        return String(str || "").replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }

      function avatarFor(name) {
        const s = (name || "üôÇ").trim();
        const ch = s[0] ? s[0].toUpperCase() : "üôÇ";
        try {
          if (/\p{Extended_Pictographic}/u.test(ch)) return ch;
        } catch {}
        return ch;
      }

      function getName() {
        return localStorage.getItem(NAME_KEY) || "";
      }
      function setName(n) {
        localStorage.setItem(NAME_KEY, n);
        $("whoNow").textContent = n || "anonyme";
      }

      function setSession() {
        const exp = Date.now() + SESSION_HOURS * 60 * 60 * 1000;
        sessionStorage.setItem(SESSION_KEY, String(exp));
      }
      function hasSession() {
        const exp = parseInt(sessionStorage.getItem(SESSION_KEY) || "0", 10);
        return exp && Date.now() < exp;
      }
      function clearSession() {
        sessionStorage.removeItem(SESSION_KEY);
      }

      function eggSet(k, v = "1") {
        localStorage.setItem(k, v);
      }
      function eggGet(k) {
        return localStorage.getItem(k);
      }
      function eggClear() {
        localStorage.removeItem(EGG_RADAR);
        localStorage.removeItem(EGG_BOSS);
      }

      /**********************
       * Supabase: read/write
       **********************/
      async function fetchMessages() {
        const { data, error } = await sb
          .from("jb_messages")
          .select("*")
          .eq("room", ROOM_CODE)
          .order("ts", { ascending: true })
          .limit(200);

        if (error) {
          console.error(error);
          toast("‚ùå Supabase: impossible de lire");
          return [];
        }
        return data || [];
      }

      async function insertMessage(who, text, type = "msg") {
        const payload = {
          room: ROOM_CODE,
          who,
          text,
          type,
          ts: new Date().toISOString(),
        };

        const { error } = await sb.from("jb_messages").insert(payload);
        if (error) {
          console.error(error);
          toast("‚ùå Supabase: impossible d'envoyer");
          return false;
        }
        return true;
      }

      /**********************
       * UI switching
       **********************/
      async function showChat() {
        $("loginCard").style.display = "none";
        $("chatCard").style.display = "block";
        $("lockBtn").style.display = "inline-flex";

        // restore invasion theme if egg already triggered on this device
        if (eggGet(EGG_BOSS) === "1") enableInvasionTheme(false);

        $("modeNow").textContent = document.body.classList.contains("agent")
          ? "agent"
          : document.body.classList.contains("invasion")
          ? "invasion"
          : "normal";

        confettiPop(document.body.classList.contains("invasion"));
        toast("‚úÖ Bienvenue dans la room secr√®te");

        if (!getName()) askName();
        else $("whoNow").textContent = getName();

        await renderChat(true);
        await insertMessage(
          "SYSTEM",
          "Quelqu‚Äôun est entr√© dans la room üëÄ",
          "sys"
        );
      }

      function showLogin() {
        $("loginCard").style.display = "block";
        $("chatCard").style.display = "none";
        $("lockBtn").style.display = "none";
      }

      function lock() {
        clearSession();
        showLogin();
        toast("üîí Verrouill√©");
        $("password").value = "";
        $("password").focus();
      }

      /**********************
       * Chat rendering
       **********************/
      async function renderChat(scrollBottom = false) {
        const box = $("chatBox");
        const msgs = await fetchMessages();
        const me = getName() || "anonyme";

        box.innerHTML = msgs
          .map((m) => {
            const who = escapeHtml(m.who);
            const text = escapeHtml(m.text);
            const time = frTime(m.ts);
            const isSys = m.type === "sys";
            const isMe = !isSys && m.who === me;

            const cls = isSys ? "msg sys" : isMe ? "msg me" : "msg";
            const av = isSys ? "üõ∞Ô∏è" : avatarFor(m.who);

            return `
              <div class="${cls}">
                <div class="avatar">${av}</div>
                <div class="bubble">
                  <div class="metaLine">
                    <div class="who">${isSys ? "SYSTEM" : who}</div>
                    <div class="time">${time}</div>
                  </div>
                  <div class="text">${text}</div>
                </div>
              </div>
            `;
          })
          .join("");

        if (scrollBottom) box.scrollTop = box.scrollHeight;
      }

      async function sendMessage(raw) {
        const text = (raw || "").trim();
        if (!text) return;

        if (text.startsWith("/")) {
          await handleCommand(text);
          $("msg").value = "";
          return;
        }

        const me = getName() || "anonyme";
        const ok = await insertMessage(me, text, "msg");
        if (ok) {
          $("msg").value = "";
          await renderChat(true);
        }
      }

      async function handleCommand(cmd) {
        const c = cmd.trim();

        if (c.toLowerCase() === "/help") {
          toast(
            "üìú /help /boom /lock /name /refresh /radar /launch omega /reset-eggs"
          );
          await insertMessage(
            "SYSTEM",
            "Commandes: /help /boom /lock /name /refresh /radar /launch omega /reset-eggs",
            "sys"
          );
          return;
        }

        if (c.toLowerCase() === "/boom") {
          confettiPop(document.body.classList.contains("invasion"));
          toast("üí• BOOM !");
          await insertMessage("SYSTEM", "üí• BOOM (confetti) !", "sys");
          return;
        }

        if (c.toLowerCase() === "/lock") {
          lock();
          return;
        }

        if (c.toLowerCase() === "/name") {
          askName();
          return;
        }

        if (c.toLowerCase() === "/refresh") {
          await renderChat(true);
          return;
        }

        // ===== Egg 1: radar =====
        if (c.toLowerCase() === "/radar") {
          eggSet(EGG_RADAR, "1");
          toast("üõ∞Ô∏è Radar activ√©‚Ä¶ signal faible d√©tect√©.");
          await insertMessage(
            "SYSTEM",
            "üõ∞Ô∏è Radar activ√©‚Ä¶ signal faible d√©tect√©.",
            "sys"
          );
          confettiPop(true);
          return;
        }

        // ===== Boss final =====
        if (c.toLowerCase() === "/launch omega") {
          if (eggGet(EGG_RADAR) !== "1") {
            toast("üõë S√©quence refus√©e. Indice: /radar");
            await insertMessage(
              "SYSTEM",
              "üõë S√©quence refus√©e. Indice: /radar",
              "sys"
            );
            return;
          }

          eggSet(EGG_BOSS, "1");
          await insertMessage("SYSTEM", "‚ö†Ô∏è PROTOCOLE OMEGA ARM√â‚Ä¶", "sys");
          await triggerBossFinal();
          return;
        }

        if (c.toLowerCase() === "/reset-eggs") {
          eggClear();
          disableInvasionTheme();
          toast("üßΩ Eggs reset (retour normal).");
          await insertMessage(
            "SYSTEM",
            "üßΩ Eggs reset (retour normal).",
            "sys"
          );
          return;
        }

        toast("‚ùì Commande inconnue. Essaie /help");
      }

      function askName() {
        const current = getName();
        const n = prompt(
          "Choisis ton pseudo (ex: Ulysse, Papa, Maman, Ninja ü•∑)",
          current || ""
        );
        if (n !== null) {
          const clean = n.trim().slice(0, 22);
          if (clean) {
            setName(clean);
            toast(`üë§ Pseudo = ${clean}`);
            insertMessage("SYSTEM", `${clean} a chang√© de pseudo ‚ú®`, "sys");
          }
        }
      }

      /**********************
       * Boss final FX
       **********************/
      async function triggerBossFinal() {
        // 1) Burn overlay ON + shake
        $("burn").classList.add("on");
        document.body.classList.add("shake");

        toast("üî• OMEGA: surcharge‚Ä¶");
        await insertMessage("SYSTEM", "üî• OMEGA: surcharge‚Ä¶", "sys");

        await sleep(650);

        // 2) White flash (cheap but effective)
        $("burn").style.filter = "brightness(1.2)";
        await sleep(250);
        $("burn").style.filter = "";

        // 3) Enable invasion theme
        enableInvasionTheme(true);

        // 4) Epic system messages
        await insertMessage("SYSTEM", "üõ∏ INVASION EN COURS‚Ä¶", "sys");
        await sleep(500);
        await insertMessage(
          "SYSTEM",
          "Commandant, vous avez r√©veill√© quelque chose dans le vide‚Ä¶",
          "sys"
        );

        // 5) Cleanup burn overlay (keeps theme)
        await sleep(1200);
        $("burn").classList.remove("on");
        document.body.classList.remove("shake");

        $("modeNow").textContent = "invasion";
        confettiPop(true);
        await renderChat(true);
      }

      function enableInvasionTheme(withStars) {
        document.body.classList.add("invasion");
        $("modeNow").textContent = "invasion";
        if (withStars) startStars();
      }

      function disableInvasionTheme() {
        document.body.classList.remove("invasion");
        $("modeNow").textContent = document.body.classList.contains("agent")
          ? "agent"
          : "normal";
        stopStars();
      }

      function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      /**********************
       * Stars canvas
       **********************/
      const starCanvas = document.getElementById("stars");
      const starCtx = starCanvas.getContext("2d");
      let starRAF = null;
      let stars = [];

      function resizeStars() {
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        starCanvas.width = Math.floor(window.innerWidth * dpr);
        starCanvas.height = Math.floor(window.innerHeight * dpr);
        starCanvas.style.width = window.innerWidth + "px";
        starCanvas.style.height = window.innerHeight + "px";
        starCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }

      function initStars() {
        const n = Math.floor(
          Math.min(220, Math.max(120, window.innerWidth / 6))
        );
        stars = Array.from({ length: n }, () => ({
          x: Math.random() * window.innerWidth,
          y: Math.random() * window.innerHeight,
          r: Math.random() * 1.6 + 0.2,
          v: Math.random() * 0.45 + 0.15,
          tw: Math.random() * Math.PI * 2,
        }));
      }

      function drawStars(t) {
        starCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
        for (const s of stars) {
          s.tw += 0.02;
          const alpha = 0.35 + 0.35 * Math.sin(s.tw);
          starCtx.globalAlpha = alpha;

          // color shift for invasion
          const c =
            Math.sin(t / 600 + s.tw) > 0
              ? "rgba(34,211,238,1)"
              : "rgba(124,58,237,1)";
          starCtx.fillStyle = c;

          starCtx.beginPath();
          starCtx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
          starCtx.fill();

          s.y += s.v;
          if (s.y > window.innerHeight + 5) {
            s.y = -5;
            s.x = Math.random() * window.innerWidth;
          }
        }
        starCtx.globalAlpha = 1;
      }

      function loopStars(t) {
        drawStars(t || 0);
        starRAF = requestAnimationFrame(loopStars);
      }

      function startStars() {
        resizeStars();
        initStars();
        if (!starRAF) starRAF = requestAnimationFrame(loopStars);
      }

      function stopStars() {
        if (starRAF) cancelAnimationFrame(starRAF);
        starRAF = null;
        starCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
      }

      window.addEventListener("resize", () => {
        if (document.body.classList.contains("invasion")) startStars();
      });

      /**********************
       * Login
       **********************/
      function tryEnter() {
        const val = $("password").value.trim();

        // Egg: "agent" in password field toggles agent mode
        if (val.toLowerCase() === "agent") {
          document.body.classList.toggle("agent");
          $("modeNow").textContent = document.body.classList.contains("agent")
            ? "agent"
            : document.body.classList.contains("invasion")
            ? "invasion"
            : "normal";
          toast(
            `üï∂Ô∏è Mode agent ${
              document.body.classList.contains("agent") ? "ON" : "OFF"
            }`
          );
          $("password").value = "";
          return;
        }

        if (val === ROOM_PASSWORD) {
          setSession();
          showChat();
        } else {
          toast("üö´ Mot de passe incorrect");
        }
      }

      /**********************
       * Wire up
       **********************/
      $("enterBtn").addEventListener("click", tryEnter);
      $("password").addEventListener("keydown", (e) => {
        if (e.key === "Enter") tryEnter();
      });

      $("sendBtn").addEventListener("click", () => sendMessage($("msg").value));
      $("msg").addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage($("msg").value);
        }
      });

      $("changeNameBtn").addEventListener("click", askName);

      $("clearBtn").addEventListener("click", async () => {
        if (!confirm("Vider tout le chat (pour tout le monde) ?")) return;
        const { error } = await sb
          .from("jb_messages")
          .delete()
          .eq("room", ROOM_CODE);
        if (error) {
          console.error(error);
          toast("‚ùå Supabase refuse (active la policy DELETE).");
          return;
        }
        toast("üßπ Chat vid√©");
        await renderChat(true);
      });

      $("lockBtn").addEventListener("click", lock);

      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") lock();
      });

      // boot
      if (hasSession()) showChat();
      else {
        showLogin();
        $("password").focus();
      }

      if (getName()) $("whoNow").textContent = getName();

      // refresh auto toutes les 2s
      setInterval(() => {
        if ($("chatCard").style.display !== "none") renderChat(false);
      }, 2000);
    </script>
  </body>
</html>
